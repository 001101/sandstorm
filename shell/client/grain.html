<template name="grainView">
  {{!-- This template is rendered manually using Blaze.renderWithData() for each currently-open
        grain and then injected into .main-content. We do things manually so that we can be
        sure that adding or removing grains from the open grain list does not cause other grains'
        iframes to be re-rendered, losing state. --}}
  {{#with unpackedGrainState}}
    <div class="grain-container {{#if active}}active-grain{{else}}inactive-grain{{/if}}">
    {{#if error}}
      {{#if inMyTrash}}
        {{> grainInMyTrash . }}
      {{else}}
        {{#if inOwnersTrash}}
          {{> grainInOwnersTrash ""}}
        {{else}}{{#if grainOwnerSuspended}}
          {{> grainOwnerSuspended ""}}
        {{else}}
          {{#if unauthorized}}
            {{#if token}}
              {{> revokedShareLink ""}}
            {{else}}
              {{> requestAccess . }}
            {{/if}}
          {{else}}
            {{#if notFound}}
              <p class="grain-not-found grain-interstitial">
                {{_ "grains.notFound" id="{{grainId}}"}}
              </p>
            {{else}}
               <pre>{{error}}</pre>
            {{/if}}
          {{/if}}
        {{/if}}{{/if}}
      {{/if}}
    {{else}}
    {{#if appOrigin}}
      {{!-- Selenium requires iframes to have an id in order to select them. `id` is only
            used for testing purposes. --}}
      <iframe data-grainid="{{grainId}}" id="{{idPrefix}}grain-frame-{{grainId}}" class="grain-frame" src="{{appOrigin}}/_sandstorm-init?sessionid={{sessionId}}&path={{originalPath}}"></iframe>
      {{#with signinOverlay}}
        {{#modalDialogWithBackdrop class="signin" onDismiss=closeSignInOverlay}}
          {{> loginButtonsDialog label=label accountsUi=globalAccountsUi}}
        {{/modalDialogWithBackdrop}}
      {{/with}}
      {{#if hasNotLoaded}}
        {{> _grainSpinner ""}}
      {{/if}}
    {{else}}
    {{#if interstitial.chooseIdentity}}
      <div class="grain-interstitial">
        <p>{{_ "grains.openWithWhichIdentity"}}</p>
        {{> identityPicker identityPickerData}}
        {{#if interstitial.showIncognito}}
        <button class="incognito-button" data-token="{{token}}">{{_ "grains.openInIncognitoMode"}}</button>
        {{/if}}
      </div>
    {{else}}
      {{> _grainSpinner ""}}
    {{/if}}
    {{/if}}
    {{/if}}
    </div>
  {{/with}}
</template>

<template name="grainInMyTrash">
  <div class="grain-interstitial">
    <p>
      {{_ "grains.inTrash"}}
    </p>
    <button class="restore-from-trash">{{_ "grains.restoreToMainList"}}</button>
  </div>
</template>

<template name="grainInOwnersTrash">
  <div class="grain-interstitial">
    <p>
      {{_ "grains.removedByOwner"}}
    </p>
  </div>
</template>

<template name="grainOwnerSuspended">
  <div class="grain-interstitial">
    <p>
      {{_ "grains.ownerSuspended"}}
    </p>
  </div>
</template>


<template name="wrongIdentity">
  <div class="grain-interstitial">
    <p>
      {{_ "grains.restricted"}}
    </p>
    {{> identityCardSignInButton identity=recipient unclickedMessage=unclickedMessage}}
  </div>
</template>

<template name="requestAccess">
  <div class="request-access grain-interstitial">
  <p>{{_ "grains.permissionDenied"}}</p>
  {{#if currentUser}}
    {{#with status}}
      {{#if showButton}}
        <button class="request-access" title="{{_ "grains.requestAccessHint"}}">
          {{_ "grains.requestAccess"}}
        </button>
      {{/if}}
      {{#if chooseIdentity}}
        <p>{{_ "grains.warnIdentityRevealing"}}</p>
        <p> {{chooseIdentityText}} </p>
        {{> identityPicker identityPickerData}}
      {{/if}}
      {{#if waiting}}
        <p>{{_ "grains.sendRequest"}}</p>
      {{/if}}
      {{#if success}}
        <p>
          {{_ "grains.waitForApproving"}}
        </p>
      {{/if}}
      {{#with error}}
        <p>{{_ "grains.requestFailed" .}}</p>
      {{/with}}
    {{/with}}
  {{else}}
    {{_ "grains.signInPlease"}}
  {{/if}}
  </div>
</template>

<template name="invalidToken">
   <pre> {{_ "grains.invalidToken" token}} </pre>
</template>

<template name="revokedShareLink">
  <p class="grain-interstitial">{{_ "grains.linkRevoked"}}</p>
</template>

<template name="grainTitle">
  {{#with fullTitle}}
    <div class="editable" title="Rename" id="grainTitle" tabindex="0">
      {{#if hasSubtitle}}
        <div class="main-title">{{title}}</div>
        <div class="subtitle">
          {{#with was}}
            {{_ "grains.was" .}}
          {{/with}}
          {{#with renamedFrom}}
            {{_ "grains.renamedFrom" .}}
          {{/with}}
        </div>
      {{else}}
        {{title}}
      {{/if}}
    </div>
  {{/with}}
</template>
<template name="grainDeleteButton">
  <button class="grain-button" title="{{_ "grains.moveToTrashHint"}}" id="deleteGrain">{{_ "grains.moveToTrash"}}</button>
</template>
<template name="grainDebugLogButton">
  <button class="grain-button" title="{{_ "grains.showLogHint"}}" id="openDebugLog">{{_ "grains.showLog"}}</button>
</template>
<template name="grainBackupButton">
  <button class="grain-button" title="{{_ "grains.backupHint"}}" id="backupGrain">{{_ "grains.backup"}}</button>
</template>

<template name="grainBackupPopup">
  <h4>{{_ "grains.backupPopup.title"}}</h4>
  {{#if state.showWarning }}
    <p class="warning-intro">
      {{_ "grains.backupPopup.warning"}}
    </p>
    <p class="warning-body">
      {{ state.showWarning }}
    </p>
  {{/if}}
  {{#if state.processing}}
    <p> {{_ "grains.backupPopup.processing"}} </p>
  {{/if}}
  {{#if state.error}}
    <p class="error">{{_ "grains.backupPopup.error" state.error}}</p>
  {{/if}}

  <div class="button-row">
    <button name="cancel" title="{{_ "grains.backupPopup.cancelHint"}}">{{_ "grains.backupPopup.cancel"}}</button>
    {{#if state.processing}}
      <div class="spinner"></div>
    {{/if}}

    {{#if state.showWarning}}
      <button name="confirm" title="{{_ "grains.backupPopup.confirmHint"}}">{{_ "grains.backupPopup.confirm"}}</button>
    {{/if}}
  </div>
</template>

<template name="grainRestartButton">
  <button class="grain-button" title="{{_ "grains.restartHint"}}" id="restartGrain">{{_ "grains.restart"}}</button>
</template>

<template name="grainApiTokenButton">
  <button class="show-popup" title="{{_ "grains.getWebkeyHint"}}">
    {{{_ "grains.getWebkey"}}}
  </button>
</template>

<template name="grainApiTokenPopup">
  <h4>{{_ "grains.apiTokenPopup.title"}}</h4>
  {{#if generatedApiToken}}
    {{#if generatedApiTokenPending}}
      <p>{{_ "grains.apiTokenPopup.processing"}}</p>
      <p><button id="resetApiToken">{{_ "grains.apiTokenPopup.cancel"}}</button></p>
    {{else}}
      <p>{{_ "grains.apiTokenPopup.copyForExternalApp"}}</p>
        <a id="apiTokenText" class="copy-me" href="{{generatedApiToken}}">{{generatedApiToken}}</a>
      {{#if currentUser}}
        <p><button id="resetApiToken">{{_ "grains.apiTokenPopup.back"}}</button></p>
      {{/if}}
    {{/if}}
  {{else}}
    <p>{{_ "grains.apiTokenPopup.description"}}</p>
    <p><form class="newApiToken">
    {{_ "grains.apiTokenPopup.labelTitle"}} <input type="text" id="api-token-petname" placeholder="{{_ "grains.apiTokenPopup.labelPlaceholder"}}">
    {{#with viewInfo}}
      {{#if roles}}
        {{_ "grains.apiTokenPopup.roleTitle"}}
        <select id="api-token-role">
          <option title="has every app permission" selected=true>{{_ "grains.apiTokenPopup.permissionTitle"}}</option>
          {{#each roles}}
            <option title={{verbPhrase.defaultText}}
                    data-obsolete={{obsolete}}>
              {{title.defaultText}}</option>
          {{/each}}
        </select>
      {{/if}}
    {{/with}}
    <button>{{_ "grains.apiTokenPopup.create"}}</button></form></p>
    {{#if existingTokens}}
      <p>{{_ "grains.apiTokenPopup.webkeyListTitle"}}</p>
      <ul>
      {{#each existingTokens}}
        {{#if displayToken}}
          <li>
            <span class="token-petname" data-token-id="{{_id}}">
              {{petname}} ({{dateString created}})
            </span>
            <button class="revoke-token" title="{{_ "grains.apiTokenPopup.revokeHint"}}" data-token-id="{{_id}}">{{_ "grains.apiTokenPopup.revoke"}}</button>
          </li>
        {{/if}}
      {{/each}}
      </ul>
    {{/if}}
  {{/if}}
</template>

<template name="grainShareButton">
  <button class="show-popup" title="{{_ "grains.shareAccessHint"}}">
    {{_ "grains.shareAccess"}}
  </button>
</template>

<template name="whoHasAccess">
   <img src="/people.svg">
</template>

<template name="whoHasAccessPopup">
  <h4 class="who-has-access">{{_ "grains.whoHasAccessPopup.title"}}</h4>
  {{#if isReady}}
  <div class="tables-container">
    <h5>{{_ "people.title"}}</h5>
    {{#if transitiveShares.identityOwnedShares.empty}}
      {{#if existingShareTokens}}
        <p>{{_ "grains.whoHasAccessPopup.noLoggedInUsers"}}</p>
      {{else}}
        {{#if transitiveShares.grainOwnedShares.empty}}
          <p>{{_ "grains.whoHasAccessPopup.nobody"}}</p>
        {{else}}
          <p>{{_ "grains.whoHasAccessPopup.noLoggedInUsers"}}</p>
        {{/if}}
      {{/if}}
    {{else}}
      <table class="people">
        {{#each transitiveShares.identityOwnedShares}}
          <tr>
            <td> {{displayName recipient}} </td>
            <td> {{_ "grains.whoHasAccessPopup.addedBy"}}
              <ul>
                {{#each dedupedShares}}
                  <li>
                    {{displayName identityId}}
                    {{#if isCurrentIdentity identityId}}
                      <button class="revoke-access" title="{{_ "grains.whoHasAccessPopup.revokeHint"}}" data-recipient="{{../recipient}}">
                        {{_ "grains.whoHasAccessPopup.revoke"}}
                      </button>
                    {{/if}}
                  </li>
                {{/each}}
              </ul>
            </td>
          </tr>
        {{/each}}
      </table>
    {{/if}}
    {{#unless transitiveShares.grainOwnedShares.empty}}
      <h5>{{_ "grains.title"}}</h5>
      <table class="grains">
        {{#each transitiveShares.grainOwnedShares}}
          <tr>
            <td>{{grainTitle recipient}}</td>
            <td> {{_ "grains.whoHasAccessPopup.addedBy"}}
              <ul>
                {{#each dedupedShares}}
                  <li>
                    {{displayName identityId}}
                    {{#if isCurrentIdentity identityId}}
                      <button class="revoke-access" title="{{_ "grains.whoHasAccessPopup.revokeHint"}}" data-recipient="{{../recipient}}">
                        {{_ "grains.whoHasAccessPopup.revoke"}}
                      </button>
                    {{/if}}
                  </li>
                {{/each}}
              </ul>
            </td>
          </tr>
        {{/each}}
      </table>
    {{/unless}}

    {{#if existingShareTokens}}
      <h5>{{_ "sharingLinks.title"}}</h5>
      <table class="shared-links">
      {{!-- Renamed from sharing-links to shared-links due to a common adblock rule
            in https://easylist.adblockplus.org/fanboy-social.txt --}}
        {{#each existingShareTokens}}
          {{#if displayToken}}
            <tr>
              <td>
                <span class="token-petname" data-token-id="{{_id}}">
                  {{getPetname}} ({{dateString created}})
                </span>
              </td>
              <td>
                {{#if viewInfo.roles}}
                  <select class="share-token-role" data-token-id="{{_id}}">
                    {{#each indexedRoles}}
                      <option title={{title.defaultText}}
                              data-obsolete={{obsolete}}
                              selected={{hasCurrentRole ..}}>
                        {{roleText}}</option>
                    {{/each}}
                    {{#if hasCustomRole .}}
                      <option title="custom role" selected=true>
                        {{_ "grains.whoHasAccessPopup.hasCustomPermissions"}}
                      </option>
                    {{/if}}
                  </select>
                {{/if}}
              </td>
              <td>
                <button class="revoke-token" title="Revoke" data-token-id="{{_id}}">Revoke</button>
              </td>
            </tr>
          {{/if}}
        {{/each}}
      </table>
      {{/if}}
   </div>
   {{else}}
   <img class="spinner" src="/spinner_96.gif" alt="loading">
   {{/if}}
</template>

<template name="selectRole">
  {{#with viewInfo}}
  {{#if roles}}
  <select class="share-token-role" title="{{_ "grains.selectRoleHint"}}" disabled={{../disabled}}>
    {{#each roles}}
    <option title={{title.defaultText}}
            data-obsolete={{obsolete}}
            {{!-- We need this special attributed because apparently Meteor does not play nice
                  with HTMLOptionElement.defaultSelected. --}}
            data-default-selected={{default}}
            selected={{default}}>
      {{roleText}}</option>
    {{/each}}
  </select>
  {{/if}}
  {{/with}}
</template>

<template name="emailInviteTab">
  <form class="email-invite">
    {{#if isDemoUser}}
      <p class="demo-mode-alert">
        {{_ "grains.emailInviteTab.demoModeAlert"}}
      </p>
    {{/if}}
    <p>
    <span class="icon icon-people"></span>
    {{> contactInputBox contacts=contacts preselectedIdentityId=preselectedIdentityId
         disabled=isDemoUser}}
    {{> selectRole viewInfo=viewInfo disabled=isDemoUser}}
    </p>
    <div>
      <textarea class="personal-message" disabled={{isDemoUser}}
                placeholder="{{_ "grains.emailInviteTab.personalMessagePlaceholder"}}"></textarea>
    </div>
    {{#if completionState.clear}}
    <div class="button-container" role="presentation">
      {{#with invitationExplanation}}
        {{!-- Display the entire message in the hover text, in case "overflow: ellipsis" causes
              part of the message to be hidden in the main view. --}}
        <p class="invitation-explanation" title="{{.}}">{{.}}</p>
      {{/with}}
      <button disabled={{isDemoUser}}>{{_ "grains.emailInviteTab.send"}}</button>
    </div>
    {{/if}}
  </form>
  {{#with completionState}}
    {{#if success}}
     <p>{{_ "grains.emailInviteTab.success"}}</p>
     <p><button class="reset-invite">{{_ "grains.emailInviteTab.reset"}}</button></p>
    {{/if}}
    {{#if pending}}
      <p>{{_ "grains.emailInviteTab.sending"}}</p>
    {{/if}}
    {{#if error}}
      <p> {{error}} </p>
      <p><button class="start-over-invite">{{_ "grains.emailInviteTab.startOver"}}</button></p>
    {{/if}}
  {{/with}}
</template>

<template name="shareableLinkTab">
  <form class="new-share-token">
    <p>
      <span class="icon icon-people"></span>
      Anyone with this link{{#if viewInfo.roles}}:{{else}} can access the grain.{{/if}}
      {{> selectRole viewInfo=viewInfo}}
    </p>
    <input type="text" class="label" placeholder="Label (optional)">
    <p class="label-explanation">
      Use a label to remind yourself to whom you sent this unique link.</p>
    {{#if completionState.clear}}
      <div class="button-container">
        <button>Create</button>
      </div>
    {{/if}}
  </form>
  {{#with completionState}}
    {{#if success}}
      <p><span class="icon icon-copy"></span> Copy this link:</p>
      <a id="share-token-text" class="copy-me" href="{{success.url}}">{{success.url}}</a>
      <p><button class="reset-share-token">+ Create another link</button></p>
    {{/if}}
    {{#if pending}}
      <p>Generating...</p>
      <p><button class="reset-share-token">Cancel</button></p>
    {{/if}}
  {{/with}}
</template>

<template name="shareWithOthers">
  <h4 class="share-with-others">{{_ "grains.shareWithOthers.title"}}</h4>
  <div class="share-tabs" role="presentation">
    <ul role="tablist">
      <li id="send-invite-tab-header" tabindex="0" role="tab" aria-controls="send-invite-tab" aria-selected="true"> {{_ "grains.shareWithOthers.sendInviteTab"}} </li>
      <li id="shareable-link-tab-header" tabindex="-1" role="tab" aria-controls="shareable-link-tab" aria-selected="false"> {{_ "grains.shareWithOthers.shareableLinkTab"}} </li>
    </ul>
    <div id="send-invite-tab" role="tabpanel" class="tabpanel" aria-labelledby="send-invite-tab-header" aria-hidden="false">
      {{> emailInviteTab viewInfo=grain.viewInfo title=grain.title grainId=grain.grainId }}
    </div>
    <div id="shareable-link-tab" role="tabpanel" class="tabpanel" aria-labelledby="shareable-link-tab-header" aria-hidden="true">
      {{> shareableLinkTab viewInfo=grain.viewInfo }}
    </div>
  </div>

  <div class="footer">
    <span class="icon icon-people"></span>
    <button class="who-has-access">{{_ "grains.shareWithOthers.whoHasAccess"}}</button>
  </div>
</template>

<template name="grainSharePopup">
  {{#if currentGrain.isOldSharingModel}}
    <p>{{_ "grains.grainSharePopup.oldSharingModelDescription"}}</p>
    {{#if currentGrain.isOwner}}
      <p>{{_ "grains.grainSharePopup.upgradeDescription"}}</p>
      <p>{{_ "grains.grainSharePopup.upgradeWarning"}}</p>
      <p><button id="privatize-grain">{{_ "grains.grainSharePopup.upgrade"}}</button></p>
    {{/if}}
  {{else}}
    {{#if incognito}}
      <p>
        {{_ "grains.grainSharePopup.openInIncognitoMode"}}
      </p>
      {{#with currentTokenUrl}}
        <p>
          {{_ "grains.grainSharePopup.toShareAccess"}}
          <a id="share-token-text" class="copy-me" href="{{.}}">{{.}}</a>
        </p>
      {{/with}}
      <p>
        {{#if currentUser}}
          {{_ "grains.grainSharePopup.openNonAnonymouslyHead"}}
          <a class="open-non-anonymously" href="{{currentTokenUrl}}">
            {{_ "grains.grainSharePopup.openNonAnonymouslyLink"}}
          </a>{{_ "grains.grainSharePopup.openNonAnonymouslyTail"}}
        {{else}}
          {{_ "grains.grainSharePopup.signIn"}}
        {{/if}}
      </p>
    {{else}}
      {{> shareWithOthers grain=currentGrain}}
    {{/if}}
  {{/if}}
</template>

<template name="grainPowerboxRequest">
  <button class="show-popup" title="Powerbox request">
    P
  </button>
</template>
<template name="grainPowerboxRequestPopup">
  {{>powerboxRequest . }}
</template>

<template name="grainPowerboxOffer">
  <button class="show-popup" title="Powerbox offer">
    P
  </button>
</template>
<template name="grainPowerboxOfferPopup">
  <h4>Powerbox Offer</h4>
  {{#if state.webkey}}
  <div>
    <a class="copy-me" href="{{state.webkey}}" id="powerbox-offer-url">{{state.webkey}}</a>
    <button class="dismiss">Dismiss</button>
  </div>
  {{/if}}
  {{#if state.error}}
  <div>
     Error: {{state.error}}
  </div>
  {{/if}}
</template>

<template name="grain">
  {{>sandstormTopbarItem name="title" priority=5 topbar=globalTopbar template="grainTitle"}}
  {{#sandstormTopbarItem name="grain-size" priority=5 topbar=globalTopbar}}
    {{grainSize}}
  {{/sandstormTopbarItem}}

  {{>sandstormTopbarBlockReload ""}}

  {{setGrainWindowTitle}}

  {{#if hasAccess}}
    {{>sandstormTopbarItem name="share" priority=4 topbar=globalTopbar template="grainShareButton"
        popupTemplate="grainSharePopup"}}
  {{/if}}

  {{#if displayTrashButton}}
    {{>sandstormTopbarItem name="delete" topbar=globalTopbar template="grainDeleteButton"}}
  {{/if}}

  {{#if isOwner}}
    {{>sandstormTopbarItem name="debug-log" topbar=globalTopbar template="grainDebugLogButton" data=globalTopbar}}
    {{>sandstormTopbarItem name="backup" topbar=globalTopbar template="grainBackupButton"
                           data=globalTopbar popupTemplate="grainBackupPopup"}}
    {{>sandstormTopbarItem name="restart" topbar=globalTopbar template="grainRestartButton" data=globalTopbar}}
  {{/if}}

  {{#if hasAccess}}
    {{#if displayWebkeyButton}}
        {{>sandstormTopbarItem name="webkey" topbar=globalTopbar
            template="grainApiTokenButton" popupTemplate="grainApiTokenPopup"}}
    {{/if}}
    {{#if showPowerboxRequest}}
    {{>sandstormTopbarItem name="request" topbar=globalTopbar template="grainPowerboxRequest"
          startOpenModal=true popupTemplate="grainPowerboxRequestPopup" data=powerboxRequestData
          onDismiss=cancelPowerboxRequest}}
    {{/if}}
    {{#if showPowerboxOffer}}
      {{>sandstormTopbarItem name="offer" topbar=globalTopbar template="grainPowerboxOffer"
          startOpenModal=true popupTemplate="grainPowerboxOfferPopup" data=powerboxOfferData}}
    {{/if}}
  {{/if}}
</template>

<template name="share">
  {{#if currentUser}}
    {{#with grainNotFound}}
      No grain found with ID {{.}}. Maybe you need to sign in to a different account?
    {{/with}}
  {{else}}
    You must be signed in to grant access to a grain.
  {{/if}}
</template>

<template name="_grainSpinner">
  {{!-- This is a terrible hack to center this thing. The styles shold go in css, but it's
    arguably more confusing to put them there when all they're doing is this archaic pattern to
    get a horizontally+vertically centered div --}}
  <div id="grain-loading-spinner">
    <div style="display:table-cell;vertical-align:middle;">
      <div style="margin-left:auto;margin-right:auto;text-align:center;">
        <img src="/spinner_96.gif" alt="loading">
      </div>
    </div>
  </div>
</template>
